"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("rxjs"),r=require("rxjs/operators");(e=exports.FlattenOperator||(exports.FlattenOperator={})).switchMap="switchMap",e.mergeMap="mergeMap",e.concatMap="concatMap",e.exhaustMap="exhaustMap";const a=e=>null!==e&&"object"==typeof e,p=t.pipe(r.catchError(e=>t.of(e))),o=e=>e.pipe(p),i=e=>t.isObservable(e)?e:e instanceof Promise?t.from(e):t.of(e);function s([e,t,a]){return r.scan((function(e,r){return a.length>0?a.reduce((e,t)=>(...r)=>e(t(...r)))(t)(e,r):t(e,r)}),e)}const n={switchMap:r.switchMap,mergeMap:r.mergeMap,concatMap:r.concatMap,exhaustMap:r.exhaustMap};
/**
 * Reactive state container based on RxJS (https://rxjs.dev/)
 *
 * @class AsyncStore<State, ActionsUnion>
 *
 * @type State - application state interface
 * @type ActionsUnion - type union of all the actions
 */
class c{
/**
     * Default configuration
     *
     * @param {Object} config
     *  {
     *     reducer$: of(reducer({})),
     *     actionStream$: EMPTY, // if not defined, no actions will be dispatched in the store
     *     initialState$: of({}),
     *     middleware$: of([]),
     *     destroy$: NEVER // if not defined, the state subscription will live forever
     *  }
     *
     * @param {Object} options
     *  {
     *     actionFop: FlattenOps.concatMap, // Flatten operator for actions's stream.
     *     stateFop: FlattenOps.switchMap // Flatten operator for state's stream.
     *     windowTime: undefined //Maximum time length of the replay buffer in milliseconds.
     *     bufferSize: 1 //Maximum element count of the replay buffer.
     *  }
     */
constructor(e,c){this.config=e,this.options=c;const{reducer$:l,actions$:u,actionStream$:f,middleware$:$,initialState$:h,destroy$:m,flattenState$:d,shareReplayConfig:x}=function(e={},s={}){const c=e&&e.reducer$&&e.reducer$.pipe(p)||t.of((e,t)=>e),l=new t.Subject,u=(e&&e.initialState$&&e.initialState$.pipe(p)||t.of({})).pipe(r.share()),f=e&&e.middleware$&&e.middleware$.pipe(p)||t.of([]),$=e&&e.destroy$&&e.destroy$.pipe(p)||t.NEVER,h=n[s&&s.actionFlatOp||exports.FlattenOperator.concatMap],m=n[s&&s.stateFlatOp||exports.FlattenOperator.switchMap],d=s&&s.bufferSize||1,x=s&&s.windowTime;return{reducer$:c,actions$:l,actionStream$:s=>(e&&e.actionStream$&&e.actionStream$.pipe(p)||t.EMPTY).pipe(r.filter(a),r.map(i),h(o),r.tap(l),s,r.map(i)),initialState$:u,middleware$:f,destroy$:$,flattenState$:e=>e.pipe(m(o),r.map(i),m(o)),shareReplayConfig:{refCount:!1,bufferSize:d,windowTime:x}}}(this.config,this.options);this.state$=t.combineLatest(h,l,$).pipe(r.map(s),r.concatMap(f),r.startWith(h),d,r.takeUntil(m),r.shareReplay(x)),this.state$.subscribe(),this.actions$=u.pipe(r.shareReplay(x))}}exports.Store=c,exports.catchErr=p,exports.createStore=function(e={},t={}){return new c(e,t)}
/**
 *
 * @param mapFn - a function to map a state with
 * @returns {MiddlewareFn} MiddlewareFn<State>
 *
 * PS - previous state
 * NS - next state
 */,exports.filterA=e=>t=>(r,a)=>e(a)?t(r,a):r
/**
 * Reduce into state
 * @param reduceFn - a function to reduce the state and IAction together
 * @returns {MiddlewareFn} MiddlewareFn<State, IActionsUnion>
 *
 * PS - previous state
 * NS - next state
 */,exports.filterNS=e=>t=>(r,a)=>{const p=t(r,a);return e(p)?p:r}
/**
 *
 * @param filterFn - a function to filter an IAction with
 * @returns {MiddlewareFn} MiddlewareFn<State, IActionsUnion>
 */,exports.filterPS=e=>t=>(r,a)=>e(r)?t(r,a):r,exports.mapA=e=>t=>(r,a)=>t(r,e(a))
/**
 *
 * @param filterFn - a function to filter a state with
 * @returns {MiddlewareFn} MiddlewareFn<State>
 *
 * PS - previous state
 * NS - next state
 */,exports.mapNS=e=>t=>(r,a)=>e(t(r,a))
/**
 *
 * @param mapFn - a function to map an IAction with
 * @returns {MiddlewareFn} MiddlewareFn<State, IActionsUnion>
 */,exports.mapPS=e=>t=>(r,a)=>t(e(r),a),exports.mapToObservable=i,exports.reduceA=e=>t=>(r,a)=>t(r,e(r,a)),exports.reduceNS=e=>t=>(r,a)=>e(t(r,a),a)
/**
 *
 * Reduce into IAction
 * @param reduceFn - a function to reduce the state and IAction together
 * @returns {MiddlewareFn} MiddlewareFn<State, IActionsUnion>
 */,exports.reducePS=e=>t=>(r,a)=>t(e(r,a),a);
